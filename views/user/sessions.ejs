<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sessions - Parking System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar { position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; padding: 48px 0 0; box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1); }
        .sidebar-sticky { position: relative; top: 0;padding-top: .5rem; overflow-x: hidden; overflow-y: auto; }
        main { padding-top: 48px; }
        .status-badge { font-size: 0.75rem; }
        .table-responsive { max-height: 600px; }
    </style>
</head>
<body>
    <%- include('../patials/_dashheader') %>
    
    <div class="container-fluid">
        <div class="row">
            <%- include('../patials/_dashnav') %>
            
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">My Parking Sessions</h1>
                    <% if (stats) { %>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <span class="badge bg-primary me-2">Total: <%= stats.totalSessions || 0 %></span>
                            <span class="badge bg-success me-2">Active: <%= stats.activeSessions || 0 %></span>
                            <span class="badge bg-info">Spent: KSh <%= (stats.totalSpent || 0).toLocaleString() %></span>
                        </div>
                    </div>
                    <% } %>
                </div>

                <!-- Success/Error Messages -->
                <% if (success) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <%= success %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <% } %>
                
                <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <%= error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <% } %>

                <div class="card shadow">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Vehicle</th>
                                        <th>Slot</th>
                                        <th>Entry Time</th>
                                        <th>Exit Time</th>
                                        <th>Duration</th>
                                        <th>Fee</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (sessions && sessions.length > 0) { %>
                                        <% sessions.forEach(session => { %>
                                        <tr>
                                            <td>
                                                <strong><%= session.license_plate %></strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">#<%= session.slot_number %></span>
                                            </td>
                                            <td>
                                                <%= new Date(session.entry_time).toLocaleString() %>
                                            </td>
                                            <td>
                                                <% if (session.exit_time) { %>
                                                    <%= new Date(session.exit_time).toLocaleString() %>
                                                <% } else { %>
                                                    <span class="text-muted">-</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (session.duration_minutes) { %>
                                                    <% const hours = Math.floor(session.duration_minutes / 60); %>
                                                    <% const minutes = session.duration_minutes % 60; %>
                                                    <%= hours %>h <%= minutes %>m
                                                <% } else { %>
                                                    <span class="text-muted">-</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (session.total_fee) { %>
                                                    <strong>KSh <%= session.total_fee.toLocaleString() %></strong>
                                                <% } else if (session.status === 'Active') { %>
                                                    <span class="text-warning">Calculating...</span>
                                                <% } else { %>
                                                    <span class="text-muted">-</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (session.status === 'Active') { %>
                                                    <span class="badge bg-success status-badge">
                                                        <i class="fas fa-play-circle me-1"></i>Active
                                                    </span>
                                                <% } else { %>
                                                    <span class="badge bg-secondary status-badge">
                                                        <i class="fas fa-check-circle me-1"></i>Completed
                                                    </span>
                                                <% } %>
                                            </td>
                                        </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="7" class="text-center py-4 text-muted">
                                                <i class="fas fa-parking fa-3x mb-3 d-block"></i>
                                                No parking sessions found.
                                                <br>
                                                <small>Your parking sessions will appear here once you start parking.</small>
                                            </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>

                        <!-- Session Statistics -->
                        <% if (sessions && sessions.length > 0) { %>
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4><%= stats.totalSessions || 0 %></h4>
                                        <p class="mb-0">Total Sessions</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4><%= stats.activeSessions || 0 %></h4>
                                        <p class="mb-0">Active Sessions</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4>KSh <%= (stats.totalSpent || 0).toLocaleString() %></h4>
                                        <p class="mb-0">Total Spent</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% } %>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <h6><i class="fas fa-info-circle me-2"></i>How Parking Sessions Work</h6>
                    <p class="mb-0">
                        Parking sessions are automatically created when you park your vehicle and ended when you leave. 
                        You can view your session history and associated fees here. Active sessions show fees as "Calculating..." 
                        until the session is completed.
                    </p>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-dismiss alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });

            // Refresh page every 30 seconds if there are active sessions
            <% if (stats && stats.activeSessions > 0) { %>
            setTimeout(() => {
                window.location.reload();
            }, 30000);
            <% } %>
        });
    </script>
</body>
</html>